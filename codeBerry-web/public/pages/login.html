<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOGIN - Code Berry</title>
  <link rel="shortcut icon" type="imagex/png" href="../img/logo/logoIcone.ico">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/body.css">
  <link rel="stylesheet" href="../css/header.css">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/footer.css">
  <link rel="stylesheet" href="../css/login.css">
</head>

<body>
  <div class="header">
    <div class="container">
      <div class="logo-nome">
        <a href="../pages/index.html">
          <img src="../assets/img/logo/logoCurta.png" class="logo" alt="Logo da Code Berry">
        </a>
        <h1 class="nome">CodeBerry</h1>
      </div>
      <ul class="navbar">
        <li class="agora">
          <a href="../pages/index.html">Home</a>
        </li>
        <li class="agora">
          <a href="../pages/sobrenos.html">Sobre</a>
        </li>
        <li>
          <a href="../pages/calculadora.html">Simulador</a>
        </li>
        <li>|</li>
        <div class="botao">
          <button class="login">
            <a href="../pages/login.html">Login</a>
          </button>
          <button class="cadastro">
            <a href="../pages/cadastro.html">Cadastro</a>
          </button>
        </div>
      </ul>
    </div>
  </div>

  <main class="login_container">
    <section class="login_image">
      <img
        src="https://p2.trrsf.com/image/fget/cf/774/0/images.terra.com/2022/07/06/1594778894-como-cultivar-morangos-dentro-de-casa-pexels-aphiwat-chuangchoem.jpg"
        alt="Ilustração Login">
    </section>

    <section class="login_card">
      <h1>Login</h1>

      <div class="campo">
        <span>E-mail:</span>
        <input id="input_email" type="text" placeholder="Email">
      </div>

      <div class="campo">
        <span>Senha:</span>
        <input id="input_senha" type="password" placeholder="Senha">
      </div>

      <button onclick="verificarLogin()" class="botao_cadastro_login">Acessar</button>
      <p class="link-cadastro">Não possui conta? <a href="./cadastro.html">Cadastre-se</a></p>
      <div id="div_resposta" style="margin-top:1em; color:#c00;"></div>
    </section>
  </main>

  <script>
    let qtd_tentativa = 6;

    function verificarLogin() {
      var email = input_email.value.trim();
      var senha = input_senha.value.trim();
      var resposta = '';

      if (email === '') {
        resposta = 'Por favor, insira o Email.';
      } else if (senha === '') {
        resposta = 'Por favor, insira a senha.';
      } else if (qtd_tentativa <= 0) {
        resposta = 'Número de tentativas esgotado.<br>Tente novamente mais tarde.';
      } else {
        // Fetch para autenticação no backend
        fetch("/usuarios/autenticar", {
          method: "POST",
          headers: {
            "Content-type": "application/json"
          },
          body: JSON.stringify({
            emailServer: email,
            senhaServer: senha
          }),
        })
          .then(res => {
            if (res.ok) {
              return res.json();
            } else {
              throw new Error('Falha na autenticação');
            }
          })
          .then(data => {

            console.log("Resposta do back-end:", data); // Confirma se veio certo
            console.log("CNPJ que será salvo:", data.empresaId);

            // Salva o CNPJ no sessionStorage
            sessionStorage.setItem("CNPJ_EMPRESA", data.empresaId);

            console.log("CNPJ salvo:", sessionStorage.getItem("CNPJ_EMPRESA"));

            resposta = `<span style="color: green;">Login bem-sucedido! Bem-vindo ${data.nome}!</span>`;
            setTimeout(() => {
              if (data.tipo === "n3") {
                window.location.href = "../pages/n3.html";
              } else {
                window.location.href = "../pages/dashboard.html";
              }
            }, 10000);
          })
          .catch(erro => {
            qtd_tentativa--;
            resposta = `Login inválido!<br>Tentativas restantes: ${qtd_tentativa}`;
          })
          .finally(() => {
            document.getElementById('div_resposta').innerHTML = resposta;
          });

        return;
      }

      document.getElementById('div_resposta').innerHTML = resposta;
    }
  </script>
</body>

</html>